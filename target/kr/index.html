<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<title>Lucy XSS Filter</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Lucy XSS Filter</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_소개">1. 소개</a></li>
<li><a href="#_quick_start">2. Quick Start</a>
<ul class="sectlevel2">
<li><a href="#_xsspreventer">2.1. XssPreventer</a></li>
<li><a href="#_xssfilter">2.2. XssFilter</a></li>
</ul>
</li>
<li><a href="#_xsspreventer_2">3. XssPreventer</a></li>
<li><a href="#_xssfilter_2">4. XssFilter</a>
<ul class="sectlevel2">
<li><a href="#_설정_파일">4.1. 설정 파일</a></li>
<li><a href="#_xsssaxfilter">4.2. XssSaxFilter</a></li>
<li><a href="#_xssfilter_dom_방식">4.3. XssFilter (DOM 방식)</a></li>
<li><a href="#_listener">4.4. Listener</a></li>
<li><a href="#_내부_구조">4.5. 내부 구조</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_소개">1. 소개</h2>
<div class="sectionbody">
<div class="paragraph">
<p>XSS(Cross Site Scripting) 공격을 방어하는 Java 라이브러리</p>
</div>
<div class="ulist">
<ul>
<li>
<p>화이트 리스트(White List) 설정 방식</p>
<div class="ulist">
<ul>
<li>
<p>블랙리스트 방식에 비해 새로운 공격 유형에 더 안전함</p>
</li>
</ul>
</div>
</li>
<li>
<p>규칙을 선언한 XML 파일 사이의 상속, 오버라이딩 가능</p>
<div class="ulist">
<ul>
<li>
<p>보안 정책을 정하는 부서에서 상위 설정 파일을 제공하고 서비스별로 특수한 정책을 하위 선언 파일에 기술하는 정책으로 사용이 가능함</p>
</li>
</ul>
</div>
</li>
<li>
<p>메모리를 효율적으로 쓰는 SAX 방식의 HTML 파싱 모듈 제공</p>
</li>
<li>
<p>HTML5, HTML4 Transitional DTD 명세 지원</p>
</li>
<li>
<p>공격 패턴 검출 시 주석문으로 알림</p>
<div class="ulist">
<ul>
<li>
<p><code>&lt;!-- Not Allowed Tag Filtered -&#8594;</code> 주석을 추가해서 허용되지 않는 태그임을 알려줌</p>
</li>
</ul>
</div>
</li>
<li>
<p>기능 확장이 지점 제공 (ElementListener, AttributeListener)</p>
</li>
<li>
<p>Malformed HTML도 파싱 가능</p>
<div class="ulist">
<ul>
<li>
<p>EBNF(Extended Backus-Naur Form) Notation을 기반으로 재정의된 파싱 규칙을 사용하여 Malformed HTML도 원본의 변형 없이 파싱함</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">XSS란?</div>
<div class="paragraph">
<p>XSS(cross-site scripting)는 웹페이지에 악의적인 스크립트 코드를 주입할수 있는 취약점이다.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quick_start">2. Quick Start</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lucy XSS Filter는 <a href="https://search.maven.org/">Maven Central Repository</a> 에 배포되어 있다.
<code>pom.xml</code> 에 아래와 같이 의존성을 선언한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.navercorp.lucy&lt;/groupId&gt;
    &lt;artifactId&gt;lucy-xss&lt;/artifactId&gt;
    &lt;version&gt;X.X.X&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_xsspreventer">2.1. XssPreventer</h3>
<div class="paragraph">
<p>문자열에서 HTML으로 인식될만한 요소를 완전히 제거한다. 예를 들면 <code>&lt;</code> 는 <code>&#38;&#108;&#116;&#59;</code> , <code>&gt;</code> 는 <code>&#38;&#103;&#116;&#59;</code> 등으로 변환한다.</p>
</div>
<div class="paragraph">
<p>특별한 설정없이 <code>XssPreventer.escape(String)</code> 메서드를 호출한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String clean = XssPreventer.escape(dirty);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_xssfilter">2.2. XssFilter</h3>
<div class="paragraph">
<p>HTML 요소를 허용하되 XSS 공격에 위험한 요소를 걸러내야할 때 사용한다.
HTML이 허용되는 게시판의 본문 등에 적용할 수 있다.</p>
</div>
<div class="sect3">
<h4 id="_sax_방식">2.2.1. SAX 방식</h4>
<div class="paragraph">
<p>아래와 같이 검사 규칙에 대한 설정 파일을 작성한다.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>lucy-xss-superset-sax.xml</code> 을 이 저장소의 <code>/conf/lucy-xss-superset-sax.xml</code> 을 참조해 작성한다.</p>
<div class="ulist">
<ul>
<li>
<p>특별히 추가할 정책이 없다며 해당 파일을 그대로 써도 좋다.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>lucy-xss-sax.xml</code> 을 <code>/conf/lucy-xss-sax.xml</code> 참조해 작성한다.</p>
</li>
<li>
<p>모든 설정 파일을 작성 후 클래스패스의 최상위 경로에 저장한다.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>나머지 사용법은 DOM 방식일 때와 동일한다. <code>XssFilter</code> 대신 <code>XssSaxFilter</code> 를 사용한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">LucyXssFilter filter = XssSaxFilter.getInstance("lucy-xss-sax.xml");
String clean = filter.doFilter(String dirty);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dom_방식">2.2.2. DOM 방식</h4>
<div class="paragraph">
<p>아래와 같이 검사 규칙에 대한 설정 파일을 작성한다.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>lucy-xss-superset.xml</code> 을 이 저장소의 <code>/conf/lucy-xss-superset.xml</code> 을 참조해 작성한다.</p>
<div class="ulist">
<ul>
<li>
<p>특별히 추가할 정책이 없다며 해당 파일을 그대로 써도 좋다.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>lucy-xss.xml</code> 를 <code>/conf/lucy-xss.xml</code> 참조해 작성한다.</p>
</li>
<li>
<p>모든 설정 파일을 작성 후 클래스패스의 최상위 경로에 저장한다.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>XssFilter.getInstance()</code> 메서드로 LucyXssFilter의 인스턴스를 생성한다.
해당 메서드에 입력 파라미터가 없을 경우, <code>lucy-xss-superset.xml</code> 에 정의된 규칙으로 <code>LucyXssFilter</code> 인스턴스를 생성한다.
모든 설정 파일이 없을 경우 jar 파일 안에 내장된 <code>lucy-xss-default.xml</code> 에 정의된 규칙을 읽는다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">LucyXssFilter filter = XssFilter.getInstance();</code></pre>
</div>
</div>
<div class="paragraph">
<p>특정 설정 파일을 명시할때는 <code>XssFilter.getInstance(String)</code> 메서드를 활용한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">LucyXssFilter filter = XssFilter.getInstance("lucy-xss.xml");</code></pre>
</div>
</div>
<div class="paragraph">
<p>공격패턴 검출시 디버그를 위해 추가되는 주석문을 표시하지 않기 위해서는 다음과 같이 인스턴스를 생성한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">LucyXssFilter filterComment = XssFilter.getInstance("lucy-xss.xml", true);</code></pre>
</div>
</div>
<div class="paragraph">
<p>문자열 필터링은 아래와 <code>doFilter(String)</code> 메서드를 활용한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String clean = filter.doFilter(dirty);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_xsspreventer_2">3. XssPreventer</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>com.nhncorp.lucy.security.xss.XssPreventer</code> 는 모든 HTML 요소를 무력화 시키는 기능을 제공한다.
apache-common-lang의 <code>StringEscapeUtils</code> 를 내부적으로 사용하고 있다.</p>
</div>
<div class="paragraph">
<p>XssPreventer에서 에스케이프하는 문자열은 아래와 같다.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Apache Commons Lang에서 정의된 문자열</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/apache/commons-lang/blob/master/src/main/java/org/apache/commons/lang3/text/translate/EntityArrays.java#L377">BASIC_ESCAPE</a> : <code>\</code>, <code>&amp;</code>, <code>&lt;</code>, <code>&gt;</code></p>
</li>
<li>
<p><a href="https://github.com/apache/commons-lang/blob/master/src/main/java/org/apache/commons/lang3/text/translate/EntityArrays.java#L41">ISO8859_1_ESCAPE</a></p>
</li>
<li>
<p><a href="https://github.com/apache/commons-lang/blob/master/src/main/java/org/apache/commons/lang3/text/translate/EntityArrays.java#L160">HTML40_EXTENDED_ESCAPE</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>추가 문자열 : <code>'</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>아래와 같이 <code>escape</code> 메서드를 호출해서 HTML의 모든 태그를 무력화시킨 문자열로 변환한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String clean = XssPreventer.escape(dirty);</code></pre>
</div>
</div>
<div class="paragraph">
<p>치환된 문자열에서 다시 원본 메시지를 복구하려면 아래와 같이 unescape 메서드를 호출한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String origin = XssPreventer.unescape(clean);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_xssfilter_2">4. XssFilter</h2>
<div class="sectionbody">
<div class="paragraph">
<p>XSS 공격이 가능한 HTML 요소를 신뢰할 수 있는 코드로 변환하거나 삭제하는 기능을 제공한다. 공격이 가능하지 않은 HTML 요소는 허용을 한다.</p>
</div>
<div class="sect2">
<h3 id="_설정_파일">4.1. 설정 파일</h3>
<div class="paragraph">
<p>Lucy-XSS Filter의 필터링 규칙은 화이트리스트 방식으로 설정된다.
화이트리스트 방식은 허용되는 내용을 제외한 모든 부분을 필터링하여 새로운 공격 유형에 대해서도 대처 가능하다.
화이트리스트 설정 파일은 XML 형식으로 작성하며 상위 설정 파일을 상속하거나 오버라이딩 할 수 있다.</p>
</div>
<div class="paragraph">
<p>화이트리스트 설정 파일의 구조는 다음과 같다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;config xmlns="http://www.nhncorp.com/lucy-xss" extends="..."&gt;
    &lt;elementRule&gt;
    &lt;/elementRule&gt;
    &lt;attributeRule&gt;
    &lt;/attributeRule&gt;
    &lt;elementGroup name="..."&gt;
    &lt;/elementGroup&gt;
    &lt;attributeGroup name="..."&gt;
    &lt;/attributeGroup&gt;
&lt;/config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>'config&#8217;는 최상위 요소(root element)로서 다음과 같은 속성과 내용을 포함한다.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>xmlns</code> : 디폴트 네임스페이스</p>
</li>
<li>
<p><code>extends</code> : 상속 받을 설정 파일 이름(해당 파일 내에 정의된 “config”를 모두 상속받는다.)</p>
</li>
<li>
<p><code>elementRule</code> : 적용 가능한 모든 요소에 대한 필터링 규칙을 설정한다.</p>
</li>
<li>
<p><code>attributeRule</code> : 적용 가능한 모든 속성에 대한 필터링 규칙을 설정한다.</p>
</li>
<li>
<p><code>elementGroup</code> : 요소의 집합을 정의한다. (DOM 방식에서만 사용)</p>
</li>
<li>
<p><code>attributeGroup</code> : 속성의 집합을 정의한다. (DOM 방식에서만 사용)</p>
</li>
<li>
<p><code>filteringTagInComment</code> : HTML 주석(&lt;!-- 주석 -&#8594;) 내에 존재하는 요소(HTML 태그)에 대한 필터링 여부와 타입을 설정한다.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_elementrule">4.1.1. elementRule</h4>
<div class="paragraph">
<p>적용 가능한 모든 요소에 대한 필터링 규칙을 정의하며 다음과 같이 작성한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;elementRule&gt;
    …
    &lt;element name="a" endTag="true" override="true" disable="false"&gt;
        &lt;attributes&gt;
            …
            &lt;ref name="Common" /&gt;
            …
        &lt;/attributes&gt;
        &lt;elements&gt;
            …
            &lt;ref name="Inline"&gt;
                &lt;excludes&gt;
                    &lt;ref name="a" /&gt;
                &lt;/excludes&gt;
            &lt;/ref&gt;
            …
        &lt;/elements&gt;
        &lt;listener&gt;com.nhncorp.security.xss.XXXListener&lt;/listener&gt;
        …
    &lt;/element&gt;
    …
&lt;/elementRule&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>elementRule</code> : 하나 이상의 element 요소로 정의되며, element 필터링 규칙에 없는 요소는 필터링 대상이 된다.</p>
</li>
<li>
<p><code>element</code> : 하나의 요소에 대한 필터링 규칙을 설정한다.</p>
<div class="ulist">
<ul>
<li>
<p><code>name</code> : 요소 이름</p>
</li>
<li>
<p><code>endTag</code> : End Tag의 존재 유무를 <code>true/false</code> 로 설정한다. 디폴트는 <code>false</code> 이다. (DOM 방식에서만 사용)</p>
</li>
<li>
<p><code>override</code> : 'extends' 속성에 기술한 상위 설정 파일에 동일한 설정이 있으면 그 설정을 상속받을지를 설정한다. 디폴트는 `true`이다.</p>
</li>
<li>
<p><code>disable</code> : <code>name</code> 에 설정된 요소를 <code>elementRule</code> 에서 제거할지 설정한다. 디폴트는 <code>false</code> 이다.</p>
</li>
<li>
<p><code>removeTag</code> : 필터링 결과물에서 element의 삭제 유무를 <code>true/false</code> 로 설정한다. 디폴트는 <code>false</code> 이다. 가령 &lt;body&gt;의 내용만 사용되는 경우, &lt;html&gt;, &lt;head&gt;, &lt;body&gt; 등을 삭제하는데 사용될 수 있다.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>attributes</code> : element의 속성을 입력한다. (DOM 방식에서만 사용)</p>
</li>
<li>
<p><code>elements</code> : element의 하위 요소를 입력한다. (DOM 방식에서만 사용)</p>
</li>
<li>
<p><code>listener</code> : 이 화이트리스트 설정 파일의 설정만으로 해당 요소를 필터링할 수 없는 경우, <code>com.nhncorp.lucy.security.xss.event.ElementListener</code> 인터페이스를 상속하여 구현한 클래스 이름을 입력한다.</p>
</li>
<li>
<p><code>ref</code> : elementRule 또는 attributeRule에 설정된 element/attribute에 대한 레퍼런스이다. elementGroup 또는 attributeGroup을 레퍼런스할 수도 있다.</p>
</li>
<li>
<p><code>name</code> : 레퍼런스 이름.</p>
</li>
<li>
<p><code>excludes</code> : ref가 elementGroup 또는 attributeGroup의 레퍼런스인 경우 지정한 ref를 제외시킨다. (DOM 방식에서만 사용)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_attributerule">4.1.2. attributeRule</h4>
<div class="paragraph">
<p>적용 가능한 모든 속성에 대한 필터링 규칙을 정의하며, 다음과 같이 작성한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;attributeRule&gt;
    …
    &lt;attribute name="class" override="true" disable="false"&gt;
        &lt;allowedPattern&gt;&lt;![CDATA[…..]]&gt;&lt;/allowedPattern&gt;
    &lt;/attribute&gt;
    &lt;attribute name="class" override="true" disable="false" base64Decoding="true"&gt;
        &lt;notAllowedPattern&gt;&lt;![CDATA[…..]]&gt;&lt;/allowedPattern&gt;
    &lt;/attribute&gt;
    …
&lt;/attributeRule&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>attributeRule</code> : 하나 이상의 하위 attribute 태그를 가지는 부모 태그이다.</p>
</li>
<li>
<p><code>attribute</code> : 하나의 속성에 대한 필터링 규칙을 설정한다.</p>
<div class="ulist">
<ul>
<li>
<p><code>name</code> : 속성 이름</p>
</li>
<li>
<p><code>override</code> : config의 'extends' 속성에 설정한 상위 설정 파일에 동일한 설정이 있으면 그 설정을 상속받을지를 결정한다. 디폴트는 <code>true</code> 이다.</p>
</li>
<li>
<p><code>disable</code> : name에 설정된 속성을 attributeRule에서 제거할지 설정한다. 디폴트는 <code>false</code> 이다.</p>
</li>
<li>
<p><code>Base64Decoding</code> : 속성 값에 필터링 규칙을 적용하기 전에 base64 디코딩 수행 여부를 설정한다. 디폴트는 <code>false</code> 이다.</p>
</li>
<li>
<p><code>exceptionTagList</code> : attribute가 disable 설정이지만, 특정 태그에서는 해당 attribute 사용을 허용 하고 싶을 경우 사용한다. 가령, <code>&lt;attribute name="class" disable="true" /&gt;</code> 설정이 되어 있을 경우, 모든 태그에서 class 속성이 허용되지 않는다. 즉 기존에는 table 태그에서만 class 속성을 허용하고 싶을 경우 방법이 없었다. 하지만 이제는 아래와 같이 exceptionTagList 속성을 사용하면 table에서 class 속성을 사용할 수 있도록 예외처리가 가능하다.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>allowedPattern</code> : 속성 값으로 허용되는 정규 표현식(regular expression)을 입력한다. 패턴에 해당되지 않는 모든 속성 값은 필터링 된다.</p>
</li>
<li>
<p><code>notAllowedPattern</code> : 속성 값으로 허용되지 않는 정규 표현식을 입력한다. 패턴에 해당되는 모든 속성 값은 필터링 된다.
attributeRule에 notAllowedPattern과 allowedPattern이 동시에 정의되어있을 경우 notAllowedPattern을 기본 적용 후 allowedPattern으로 예외처리를 할 수 있다. &lt;br&gt; 예를 들어 현재 href 속성 값에는 디폴트 보안설정(lucy-xss-superset.xml 또는 lucy-xss-superset-sax.xml)에 따라 javascript: 패턴이 올 수 없다. &lt;br&gt; 하지만 서비스 응용에 따라 특정 javascript 메소드를 허용하고자 할 때, 해당 메소드를 allowedPattern으로 추가하면 된다.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_elementgroup_attributegroup_dom_방식에서만_사용">4.1.3. elementGroup/attributeGroup(DOM 방식에서만 사용)</h4>
<div class="paragraph">
<p>elementGroup과 attributeGroup은 각각 elementRule과 attributeRule에 설정된 element/attribute에 대한 레퍼런스의 집합을 그루핑하는 역할을 담당한다.
다음과 같이 작성한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;elementGroup name="Inline"&gt;
    …
    &lt;ref name="a" /&gt;
    …
&lt;/elementGroup&gt;

&lt;attributeGroup name="Core"&gt;
    …
    &lt;ref name="class" /&gt;
    …
&lt;/attributeGroup&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>elementGroup/attributeGroup</code> : elementRule과 attributeRule에 설정된 element/attribute들에 대한 레퍼런스의 집합을 그루핑한다.</p>
<div class="ulist">
<ul>
<li>
<p><code>name</code> : 그룹 이름</p>
</li>
<li>
<p><code>override</code> : config의 'extends' 속성에 기술한 상위 설정 파일에 동일한 설정이 있으면 그 설정을 상속받을지 설정한다. 디폴트는 <code>true</code> 이다.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ref</code> : elementRule 또는 attributeRule에 기술된 element/attribute에 대한 레퍼런스이다. 다른 elementGroup/attributeGroup을 참조할 수도 있다.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_iehackextension_ie핵_태그">4.1.4. IEHackExtension(IE핵 태그)</h4>
<div class="paragraph">
<p>Lucy-XSS Filter 에서는 IE핵을 주석이 아닌 별도의 태그로 인식하며, 어떤 태그에도 올 수 있도록 허용 하고 있다.
혹 IE 핵 태그를 삭제(비 허용)할 필요가 있다면, IE 핵 태그를 disable 시키도록 설정하면 된다.
기본적으로 IE핵 태그의 자식 컨텐츠는 삭제되지 않는다.
자식 컨텐츠를 삭제하고 싶다면 별도의 ElementListener를 구현하거나 Xss Filter에서 기본적으로 제공하는 ContentsRemoveListener를 IE 핵 태그에 리스너를 아래와 같이 설정하면 된다.
ContentsRemoveListener는 XssFilter 객체일 경우에만 사용 가능하다. XssSaxFilter에서는 제대로 동작하지 않는다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">…
&lt;element name="IEHackExtension" disable=”true”&gt;
	   &lt;listener&gt;com.nhncorp.lucy.security.xss.listener.ContentsRemoveListener&lt;/listener&gt;
&lt;/element&gt;
…</code></pre>
</div>
</div>
<div class="paragraph">
<p>IEHackExtension은 Element를 상속 받은 클래스로서 Element에서 사용하는 속성 및 메소드 모두 사용 가능하다.</p>
</div>
</div>
<div class="sect3">
<h4 id="_filteringtagincomment">4.1.5. filteringTagInComment</h4>
<div class="paragraph">
<p>Lucy-XSS Filter에서는 HTML 주석(&lt;!-- 주석문 -&#8594;)내에 존재하는 HTML 태그에 대해서 XSS 필터링 여부를 설정하고 타입을 지정할 수 있다.
설정을 명시하지 않은 경우, 주석 내에 존재하는 괄호 <code>&lt;</code> , <code>&gt;</code> 은 <code>&#38;&#108;&#116;&#59;</code> , <code>&#38;&#103;&#116;&#59;</code> 으로 변환하는 것을 디폴트로 한다.
주석 내 필터링을 통해 검출된 공격 패턴에 대해서는 동작하지 않도록 필터링할 뿐, 주석 설명은 제공하지 않는다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">…
&lt;!-- // type1 : 가장 보안 수준이 높은 타입, 모든 태그를 필터링한다. (디폴트 타입, 권장) // --&gt;
&lt;filteringTagInComment enable="true" type="strict"/&gt;

&lt;!-- // type2 : 주석 밖의 태그에 적용되는 필터링 규칙과 동일한 규칙을 사용해 태그를 필터링 한다.// --&gt;
&lt;filteringTagInComment enable="true" type="config"/&gt;

&lt;!-- // type3 : 주석 내에 존재하는 태그를 그대로 보존한다. (비권장)// --&gt;
&lt;filteringTagInComment enable="false"/&gt;
…</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_테스트">4.1.6. 테스트</h4>
<div class="paragraph">
<p>규칙이 의도대로 설정되었는지는 테스트 코드로 반드시 검증해 본다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">XssFilter filter = XssFilter.getInstance("lucy-xss-superset.xml");

@Test
public void testDirtyCodeFiltering() throws Exception {
    String dirty = "&lt;script&gt;&lt;/script&gt;";
    String clean = filter.doFilter(dirty);
    String expected = "&amp;lt;script&amp;gt;&amp;lt;/script&amp;gt;"; // 예상 문자열
    assertEquals(expecte, clean);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_xsssaxfilter">4.2. XssSaxFilter</h3>
<div class="paragraph">
<p>기본적으로 제공되는 SAX 방식용 화이트리스트 설정 파일은 다음과 같다.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>lucy-xss-default-sax.xml</p>
<div class="ulist">
<ul>
<li>
<p>HTML 4.0을 기본으로 하며, HTML 5.0과 Internet Explorer에 특화된 몇 가지 명세를 추가한 기본 설정 파일이다.</p>
</li>
<li>
<p>lucy-xss-x.x.x.jar 파일 내부에 포함되어 배포된다.</p>
</li>
</ul>
</div>
</li>
<li>
<p>lucy-xss-superset-sax.xml :</p>
<div class="ulist">
<ul>
<li>
<p>lucy-xss-default-sax.xml을 상속받아 작성된 파일이다. 회사의 보안부서에서 기초 정책을 저으이하고 있다.</p>
</li>
<li>
<p>이 저장소의 conf 디렉토리 아래에서 배포된다.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>XssSaxFilter.getInstance()</code> 메서드로 설정 파일을 지정하지 않은 경우에는 <code>lucy-xss-superset-sax.xml</code> 파일을 클래스패스에서 찾아 읽는다.
lucy-xss-superset-sax.xml 파일이 존재하지 않으면, jar 파일에 내장된 <code>lucy-xss-default-sax.xml</code> 을 읽어 들인다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">XssSaxFilter filter = XssSaxFilter.getInstance();</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>lucy-xss-superset-sax.xml</code> 을 명시적으로 지정하여 인스턴스를 생성할 수도 있다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">XssSaxFilter otherFilter = XssSaxFilter.getInstance("lucy-xss-superset-sax.xml");</code></pre>
</div>
</div>
<div class="paragraph">
<p>서비스별로 특수한 정책을 설정해야한다면 다음과 같이 설정파일을 작성한다.</p>
</div>
<div class="paragraph">
<p><code>lucy-xss-superset-sax.xml</code> 을 상속받도록 extends 속성을 추가한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;config xmlns="http://www.nhncorp.com/lucy-xss" extends="lucy-xss-superset-sax.xml"&gt;

&lt;/config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>애플리케이션의 성격에 따라서 상위 설정 파일에서 정의한 규칙을 재정의하거나 새로운 규칙을 추가한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;config xmlns="http://www.nhncorp.com/lucy-xss" extends="lucy-xss-superset-sax.xml"&gt;
    &lt;elementRule&gt;
    &lt;/elementRule&gt;

    &lt;attributeRule&gt;
    &lt;/attributeRule&gt;
&lt;/config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>입력 파라미터로 직접 작성한 XSS 설정파일("lucy-xss-sax.xml")을 읽어 들여 인스턴스를 생성한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">XssSaxFilter otherFilter = XssSaxFilter.getInstance("lucy-xss-sax.xml");</code></pre>
</div>
</div>
<div class="paragraph">
<p>공격패턴 검출시 디버그를 위해 추가되는 주석문을 표시하지 않기 위해서는 다음과 같이 인스턴스를 생성한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">XssSaxFilter filterNoComment = XssSaxFilter.getInstance(true);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">XssSaxFilter otherFilterNoComment = XssSaxFilter.getInstance("lucy-xss-sax.xml", true);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>doFilter()</code> 메서드로 필터링을 수행한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String clean = filter.doFilter(String dirty);</code></pre>
</div>
</div>
<div class="paragraph">
<p>주요 메서드들은 다음과 같다.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>static XssSaxFilter getInstance()</code> : 이 메소드는 XSS 코드가 포함된 HTML 의 모든 태그를 신뢰할 수 있는 문자열로 변환해 반환한다</p>
</li>
<li>
<p><code>static XssSaxFilter getInstance(boolean withoutComment)</code> : 이 메소드는 escape하기 전의 문자열로 변환해 리턴한다.</p>
</li>
<li>
<p><code>static XssSaxFilter getInstance(String fileName)</code> : 이 메소드는 입력한 파일 이름에 해당하는 설정 파일을 사용하여 생성한 Lucy-XSS Filter 객체를 반환한다. 해당 파일을 찾을 수 없는 경우, 예외(exception)를 발생시킨다. 공격 패턴 검출 시 추가되는 주석문을 제거하는 인스턴스 변수는 디폴트로 false 값이 지정되어 주석문이 표시된다</p>
</li>
<li>
<p><code>static XssSaxFilter getInstance(String filename, boolean withoutComment)</code> : getInstance(String fileName) 메소드와 동일하게 동작한다. 단, 공격 패턴 검출 시 추가되는 주석문 삭제를 나타내는 인스턴스 변수값이 withoutComment 파라미터 값에 의해 결정된다. true 이면 주석문을 표시하지 않는다</p>
</li>
<li>
<p><code>String doFilter(String dirty)</code> : 이 메소드는 XSS 코드가 포함된 HTML 문자열을 신뢰할 수 있는 코드로 변환하거나 삭제한 후 결과물을 인자로 받은 writer객체에 write한다. 즉 외부에서 writer를 제어할 수 있는 인터페이스를 제공한다</p>
</li>
<li>
<p><code>String doFilter(char[] dirty, int offset, int count, Writer writer)</code> : 이 메소드는 XSS 코드가 포함된 HTML 문자열을 char[]로 받아 신뢰할 수 있는 코드로 변환하거나 삭제한 후 결과물을 인자로 받은 writer객체에 write한다. 즉 외부에서 writer를 제어할 수 있는 인터페이스를 제공한다.</p>
</li>
<li>
<p><code>String doFilter(String tagName, String attName, String dirtyAttValue)</code> : 이 메소드는 특정 HTML 요소 내의 속성 값으로 삽입되는 XSS 코드를 신뢰할 수 있는 코드로 변환하거나 삭제한다.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>XssSaxFilter는 아래와 같은 규칙으로 필터링을 한다.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>닫는 태그를 검사하지 않는다(닫는 태그가 없다고 공격 태그로 간주하지는 않는다).</p>
</li>
<li>
<p>부모 자식 관계는 검사하지 않는다(ex) DIV 태그가 어느 태그에도 올 수 있다).</p>
</li>
<li>
<p>태그와 속성 관계 또한 검사하지 않는다(속성의 사용가능 여부, 속성 값의 XSS 공격 검사는 여전히 한다).</p>
</li>
<li>
<p>start tag 없이 end tag만 있을 경우, 필터링 없이 그대로 노출한다.</p>
<div class="ulist">
<ul>
<li>
<p>예) 필터링 전: <code>&lt;/div&gt;</code>, 필터링 후: <code>&lt;/div&gt;</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>기존 XssFilter는 <code>&lt;/div&gt;</code> 만 있을 경우 필터링 처리되어 <code>&#38;&#108;&#116;&#59;/div&#38;&#103;&#116;&#59;</code> 가 출력된다.</p>
</li>
<li>
<p>태그, 속성들의 포함관계를 검사하지 않기 때문에, 서비스 입장에서는 특정 위치에서의 태그 사용을 위해 필요했던 추가적인 설정들이 줄어든다.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_성능과_메모리_사용량">4.2.1. 성능과 메모리 사용량</h4>
<div class="paragraph">
<p>XssSaxFilter는 DOM 트리 생성 과정 및 부모 자식 간의 검사가 생략되어 DOM 방식에 비해 속도가 약 20% 빨라졌다.
특히 중첩된 태그가 많은 인풋일 수록 SAX 방식에서 큰 속도 향상이 있다.</p>
</div>
<div class="paragraph">
<p>DOM 파서 방식의 XssFilter를 사용할 때는 입력된 문자열의 크기 대비 8배의 메모리를 사용하였으나,XssSaxFilter는 약 3배 사용한다. (출력 문자열 + 입력 무자열의 char[]배열 + 기타 설정용 객체)</p>
</div>
<div class="paragraph">
<p>Java에서 String 클래스는 내부적으로 문자열을 저장하기 위하여 char 형의 배열을 사용한다.
이때 char 형은 자바의 문자 인코딩 방식이 유니코드이므로 1바이트가 아니라 2바이트의 크기를 가진다.
따라서 XssFilter의 대상 문자열을 파일에서 읽을 경우, 파일 용량의 약 2배 이상의 메모리가 필요하다는 점을 염두에 두어야한다.</p>
</div>
<div class="paragraph">
<p>메모리에 민감한 서비스에서는 XssFilter 객체 생성시 <code>getInstance(java.lang.String filename, boolean withoutComment)</code> 메소드의 withoutComment 인자로 true 를 넘기길 권장한다.
즉 공격 패턴 검출 시 추가되는 주석문 생성 옵션을 끌 경우 메모리 사용량을 약 10% 줄일 수 있다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">XssFilter filter = XssFilter.getInstance("lucy-xss-superset.xml", true);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_xssfilter_dom_방식">4.3. XssFilter (DOM 방식)</h3>
<div class="paragraph">
<p>DOM 방식의  XssFilter를 위해 기본 제공되는 화이트리스트 설정 파일은 아래와 같다.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>lucy-xss-default.xml</p>
<div class="ulist">
<ul>
<li>
<p>HTML 4.0을 기본으로 하며, HTML 5.0과 Internet Explorer에 특화된 몇 가지 명세를 추가한 기본 설정 파일이다.</p>
</li>
<li>
<p>lucy-xss-x.x.x.jar 파일 내부에 포함되어 배포된다.</p>
</li>
</ul>
</div>
</li>
<li>
<p>lucy-xss-superset.xml :</p>
<div class="ulist">
<ul>
<li>
<p>lucy-xss-default.xml을 상속받아 작성된 파일이다. 회사의 보안부서에서 기초 정책을 저으이하고 있다.</p>
</li>
<li>
<p>이 저장소의 conf 디렉토리 아래에서 배포된다.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>XssFilter.getInstance()</code> 메서드로 설정 파일을 지정하지 않은 경우에는 <code>lucy-xss-superset.xml</code> 파일을 클래스패스에서 찾아 읽는다.
<code>lucy-xss-superset.xml</code> 파일이 존재하지 않으면, jar 파일에 내장된 <code>lucy-xss-default.xml</code> 을 읽어 들인다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">XssFilter filter = XssFilter.getInstance();</code></pre>
</div>
</div>
<div class="paragraph">
<p>서비스별로 특수한 정책을 설정해야한다면 다음과 같이 설정파일을 작성한다.</p>
</div>
<div class="paragraph">
<p><code>lucy-xss-superset.xml</code> 을 상속받도록 extends 속성을 추가한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;config xmlns="http://www.nhncorp.com/lucy-xss" extends="lucy-xss-superset.xml"&gt;

&lt;/config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>애플리케이션의 성격에 따라서 상위 설정 파일에서 정의한 규칙을 재정의하거나 새로운 규칙을 추가한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;config xmlns="http://www.nhncorp.com/lucy-xss" extends="lucy-xss-superset.xml"&gt;
    &lt;elementRule&gt;
    &lt;/elementRule&gt;
    &lt;attributeRule&gt;
    &lt;/attributeRule&gt;

    &lt;elementGroup name="…"&gt;
    &lt;/elementGroup&gt;
    &lt;attributeGroup name="…"&gt;
    &lt;/attributeGroup&gt;
&lt;/config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>입력 파라미터로 지정한 XSS 설정파일("lucy-xss.xml")을 읽어 들여 인스턴스를 생성한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">XssFilter otherFilter = XssFilter.getInstance("lucy-xss.xml");</code></pre>
</div>
</div>
<div class="paragraph">
<p>공격 패턴 검출 시 디버그를 위해 추가되는 주석문을 표시하지 않기 위해서는 다음과 같이 인스턴스를 생성한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">XssFilter filterNoComment = XssFilter.getInstance(true);</code></pre>
</div>
</div>
<div class="paragraph">
<p>또는</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">XssFilter otherFilterNoComment = XssFilter.getInstance("lucy-xss.xml", true);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>doFilter()</code> 메서드로 필터링을 수행한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String clean = filter.doFilter(String dirty);</code></pre>
</div>
</div>
<div class="paragraph">
<p>주요 메서드들은 다음과 같다.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>static XssFilter getInstance()</code> : “lucy-xss-superset.xml”을 기본 설정 파일로 사용하며, “lucy-xss-superset.xml”이 루트 클래스패스에 없으면 XSS Filter 라이브러리(lucy-xss-1.x.x.jar) 내에 있는 “lucy-xss-default.xml”의 설정 내용을 사용한다. 공격 패턴 검출 시 추가되는 주석문을 제거하는 인스턴스 변수(withoutComment)는 디폴트로 false 값이 지정되고 공격 패턴 검출 시 주석문이 표시된다.</p>
</li>
<li>
<p><code>static XssFilter getInstance(boolean withoutComment)</code> : getInstance() 메소드와 동일하게 동작한다. 단, 공격 패턴 검출 시 추가되는 주석문 삭제를 나타내는 인스턴스 변수값이 withoutComment 파라미터 값에 의해 결정된다. true 이면 주석문을 표시하지 않는다. 공격 패턴 검출 시 추가되는 주석문  &lt;br&gt; 1. 허용되지 않은 태그 사용 시 &lt;!-- Not Allowed Tag Filtered -&#8594; &lt;br&gt; 2. 허용되지 않은 속성 사용 시 &lt;!-- Not Allowed Attribute Filtered -&#8594; &lt;br&gt; 3. 삭제 설정 된 태그 사용 시  &lt;!-- Removed Tag Filtered ( 삭제 된 태그 ) -&#8594;|</p>
</li>
<li>
<p><code>static XssFilter getInstance(String fileName)</code> : 이 메소드는 입력한 파일 이름에 해당하는 설정 파일을 사용하여 생성한 Lucy-XSS Filter 객체를 반환한다. 해당 파일을 찾을 수 없는 경우, 예외(exception)를 발생시킨다. 공격 패턴 검출 시 추가되는 주석문을 제거하는 인스턴스 변수는 디폴트로 false 값이 지정되어 주석문이 표시된다.|</p>
</li>
<li>
<p><code>static XssFilter getInstance(String filename, boolean withoutComment)</code> : getInstance(java.lang.String fileName) 메소드와 동일하게 동작한다. 단, 공격 패턴 검출 시 추가되는 주석문 삭제를 나타내는 인스턴스 변수값이 withoutComment 파라미터 값에 의해 결정된다. true 이면 주석문을 표시하지 않는다.|</p>
</li>
<li>
<p><code>String doFilter(String dirty)</code> : 이 메소드는 XSS 코드가 포함된 HTML 문자열을 신뢰할 수 있는 코드로 변환하거나 삭제한 후 결과물을 String으로 리턴한다.</p>
</li>
<li>
<p><code>String doFilter(String dirty, Writer writer)</code> : 이 메소드는 XSS 코드가 포함된 HTML 문자열을 신뢰할 수 있는 코드로 변환하거나 삭제한 후 결과물을 인자로 받은 writer객체에 write한다. 즉 외부에서 writer를 제어할 수 있는 인터페이스를 제공한다.</p>
</li>
<li>
<p><code>String doFilter(String tagName, String attName, String dirtyAttValue)</code> : 이 메소드는 특정 HTML 요소 내의 속성 값으로 삽입되는 XSS 코드를 신뢰할 수 있는 코드로 변환하거나 삭제한다.|</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>메모리에 민감한 서비스에서는 XssFilter 객체 생성시 getInstance(String filename, boolean withoutComment)메소드의 withoutComment 인자로 true 를 넘기길 권장한다.
공격 패턴 검출 시 추가되는 주석문 생성 옵션을 끌 경우 메모리 사용량을 약 5% 줄일 수 있다.
사용</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">XssFilter filter = XssFilter.getInstance(“lucy-xss-superset.xml”, true);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_listener">4.4. Listener</h3>
<div class="paragraph">
<p>확장 지점으로 <code>ElementListener</code> 와 <code>AttributeListener</code> 를 제공한다.</p>
</div>
<div class="paragraph">
<p>XssSaxFilter를 쓸 때에는 아래와 같은 제약이 있다.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Element의 자식을 추가, 삭제, 수정하는 작업을 Listener에서 할 수 없다</p>
<div class="ulist">
<ul>
<li>
<p>ContentsRemoveListener, ObjectListener 사용 불가(ParamListener로 대체)).</p>
</li>
</ul>
</div>
</li>
<li>
<p>IEHack의 관련한 스펙</p>
<div class="ulist">
<ul>
<li>
<p>"IEHack의 startTag만 있고, endTag는 없는 경우나, 또는 endTag가 깨broken인 경우 IEHack 자체(startTag)를 제거" 스펙을 지원하지 않음.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_elementlistener">4.4.1. ElementListener</h4>
<div class="paragraph">
<p><code>com.nhncorp.lucy.security.xss.event.ElementListener</code> 를 활용하면 특정 요소에 하위 요소를 추가하거나 데이터를 변경할수 있다.</p>
</div>
<div class="paragraph">
<p>예를 들어, <code>&lt;embed/&gt;</code> 태그에 <code>autostart='falase'</code> 선언과 <code>&lt;param&gt;</code> 요소를 내부에 추가하는 로직을 구현한다고 가정한다.
다음과 같이 <code>ElementListener</code> 인터페이스를 구현하는 클래스를 작성한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class EmbedListener implements ElementListener {
    public void handleElement(Element elem) {
        // autostart="false" 추가
        elem.putAttribute("autostart", "\"false\"");

        // &lt;param&gt; 요소 추가
        elem.addContent(new Element("param"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>구현한 클래스는 다음과 같이 XML 파일 안에서 지정한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;element name="embed"&gt;
    &lt;!-- ElementListener 인터페이스를 구현한 클래스 이름을 기술한다. --&gt;
    &lt;listener&gt;com.nhncorp.lucy.security.xss.test.EmbedListener&lt;/listener&gt;
&lt;/element&gt;</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_elementlistener_기본_구현체">ElementListener 기본 구현체</h5>
<div class="paragraph">
<p>Lucy-XSS Filter에서는 <code>&lt;embed/&gt;</code> 와 <code>&lt;object/&gt;</code> 요소의 취약점에 대응할 수 있는 <code>ElementListener</code> 구현체를 제공한다.
기본 구현체에는 Flash, Media Player 관련 보안 대응과 소스의 MIME 타입을 확인해서 html일 경우 이스케이프 처리하는 로직이 존재한다.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="image/object-listener-logic.png" alt="EmbedListener와 ObjectListener의 로직">
</div>
</div>
<div class="paragraph">
<p>추가로 허용하는 도메인인지 확인하기 위해 <code>white-url.xml</code> 에 기술되지 않은 리소스(URL)일 경우 <code>type</code> 속성을 확인하고 허용되지 않은 type(예를 들어 text/html)일 경우 이스케이프 처리한다.
Type 속성이 명시되어 있지 않을 경우 리소스의 확장자를 기반으로 이를 유추하고 type 속성을 추가해 준다.
검사하는 MIME 타입은 Apache Httpd에서 지원하는 MIME 타입을 바탕으로 만들어져 있으며 “text/*” 타입만을 제거하였다.
Type 속성과 리소스의 확장자 모두 존재하지 않는 경우는 서비스의 가용성을 위해 이스케이프 하지 않는다.
Xss filter에서는 허용할 MIME 타입을 추가할 수 있는 확장 지점을 제공한다.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>확장포인트(프로퍼티파일 추가) 사용방법</p>
<div class="ulist">
<ul>
<li>
<p>프로젝트의 클래스패스에 <code>xssfilter-extension.properties</code> 파일생성</p>
</li>
<li>
<p>확장자=MIME TYPE 형식으로 허용 할 확장자와 확장자에 해당하는 MIME TYPE 추가</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>예를 들어, 기본 정책으로는 막혀있는 확장자인 html을 허용하고자 한다면 아래와 같이 설정하면 된다.</p>
</div>
<div class="listingblock">
<div class="title">xssfilter-extension.properties 파일</div>
<div class="content">
<pre class="highlight"><code>html=text/html</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
프로퍼티 파일 이름이 위와 다르거나 MIME 타입 선언이 빠지면 해당 기능이 동작하지 않는다.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. ObjectListener/EmbedListener/ParamListener 필터링 규칙</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">항목</th>
<th class="tableblock halign-left valign-top">필터링 규칙</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ObjectListener
</p><p class="tableblock">(DOM 방식에서만 지원)</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>아래와 같이 파라미터를 변경하거나, 없는 경우 추가한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;param name="allowScriptAccess" value="never" /&gt;
&lt;param name="autostart" value="false" /&gt;
&lt;param name="invokeURLs" value="false" /&gt;
&lt;param name="autoplay" value="false" /&gt;
&lt;param name="enablehref" value="false" /&gt;
&lt;param name="enablejavascript" value="false" /&gt;
&lt;param name="nojava" value="true" /&gt;
&lt;param name="AllowHtmlPopupwindow" value="false"&gt;
&lt;param name="enableHtmlAccess" value="false"&gt;
&lt;param name="allowNetworking" value="internal"&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>white-url.xml</code> 에 기술된 리소스일 경우 'allowNetworking&#8217;을 "all"로, 기술되지 않은 리소스일 경우 "internal"로 변경한다.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EmbedListener</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>'invokeURLs', 'autostart' 값을 "false"로, 'allowScriptAccess' 값을 "never"로 변경한다.</p>
</div>
<div class="paragraph">
<p>white-url.xml에 기술된 리소스일 경우 'allowNetworking&#8217;을 "all"로, 기술되지 않은 리소스일 경우 "internal"로 변경한다</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ParamListener
(SAX 방식에서만 지원)</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>아래와 같이 각 파라미터의 value를 지정된 값으로 변경한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;param name="allowScriptAccess" value="never" /&gt;
&lt;param name="autostart" value="false" /&gt;
&lt;param name="invokeURLs" value="false" /&gt;
&lt;param name="autoplay" value="false" /&gt;
&lt;param name="enablehref" value="false" /&gt;
&lt;param name="enablejavascript" value="false" /&gt;
&lt;param name="nojava" value="true" /&gt;
&lt;param name="AllowHtmlPopupwindow" value="false"&gt;
&lt;param name="enableHtmlAccess" value="false"&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>param의 부모 태그인 object에 대한 처리는 XssSaxFilter 자체적인 로직에서 처리한다.
결국 SAX 방식에서도 param 태그에 대해 ParamListener를 사용하면, 기존 ObjectListener와 동일한 효과가 있다.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>Object</code>, <code>Embed</code> 태그는 디폴트로 제공되는 <code>lucy-xss-superset.xml</code> 설정 파일에는 disable 처리가 되어 있다.
서비스에 따라서는 이 태그들을 사용할 필요가 있는데, 이럴 경우 보안설정이 추가된 <code>ObjectListener</code> / <code>EmbedListener</code> / <code>ParamListener</code> 를 사용해서 XSS 공격을 방어해야 한다.
그렇게 사용할 경우에는 <code>lucy-xss-superset.xml</code> 을 상속하여, 아래와 같이 설정 파일에 기술한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;elementRule&gt;
    &lt;element name="embed" disable="false"&gt;
        &lt;listener&gt;com.nhncorp.lucy.security.xss.listener.EmbedListener&lt;/listener&gt;
    &lt;/element&gt;
    &lt;element name="object" disable="false"&gt;
        &lt;listener&gt;com.nhncorp.lucy.security.xss.listener.ObjectListener&lt;/listener&gt;
    &lt;/element&gt;
&lt;/elementRule&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>XssSaxFilter를 사용하는 경우 <code>lucy-xss-superset-sax.xml</code> 을 상속하여, 아래와 같이 설정 파일에 기술한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">...
&lt;elementRule&gt;
    &lt;element name="embed" disable="false"&gt;
        &lt;listener&gt;com.nhncorp.lucy.security.xss.listener.EmbedListener&lt;/listener&gt;
    &lt;/element&gt;
    &lt;element name="object" disable="false"&gt;&lt;/element&gt;
    &lt;element name="param" disable="false"&gt;
        &lt;listener&gt;com.nhncorp.lucy.security.xss.listener.ParamListener&lt;/listener&gt;
    &lt;/element&gt;
&lt;/elementRule&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ObjectListener</code> 와 <code>EmbedListener</code> , <code>ParamListener</code> 는 <code>white-url.xml</code> 에 설정된 내용을 바탕으로 필터링을 수행한다.
`white-url.xml`은 클래스패스의 최상위 경로에 존재해야 한다.
이 파일이 해당 경로에 없으면 모든 URL 리소스가 필터링 대상이 되므로, 반드시 파일을 작성해야 한다.</p>
</div>
<div class="listingblock">
<div class="title">white-url.xml 예시</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;white-url&gt;
    &lt;domain name="http://www.naver.com" desc="네이버"&gt;
        &lt;pattern&gt;http://serviceapi.nmv.naver.com/*&lt;/pattern&gt;
        &lt;pattern&gt;http://scrap.ad.naver.com/*&lt;/pattern&gt;
    &lt;/domain&gt;
    &lt;domain name="http://www.daum.net" desc="다음"&gt;
        &lt;pattern&gt;http://flvs.daum.net/flvPlayer.swf*&lt;/pattern&gt;
    &lt;/domain&gt;

    ...
&lt;/white-url&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_attributelistener">4.4.2. AttributeListener</h4>
<div class="paragraph">
<p><code>com.nhncorp.lucy.security.xss.event.AttributeListener</code> 를 활용하면 모든 요소들의 특정 속성에 추가적인 작업을 수행할 수 있다.</p>
</div>
<div class="paragraph">
<p>예를 들어, <code>src</code> 속성을 가지는 모든 요소들에 대해 허락되지 않은 URL은 빈 문자열로 치환하는 처리를 한다고 가정한다.
아래와 같이 <code>AttributeListener</code> 를 구현한 <code>SrcAttributeListener</code> 를 작성한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">WhiteUrlList list = WhiteUrlList.getInstance();

public void handleAttribute(Attribute attr) {
    if (!list.contains(attr.getValue())) {
        attr.setValue("\"\"");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>다음과 같이 XML 설정으로 <code>SrcAttributeListener</code> 를 추가한다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;attributeRule&gt;
    &lt;attribute name="src"&gt;
        &lt;listener&gt;com.nhncorp.lucy.security.xss.listener.SrcAttributeListener&lt;/listener&gt;
    &lt;/attribute&gt;
&lt;/attributeRule&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_내부_구조">4.5. 내부 구조</h3>
<div class="paragraph">
<p>Lucy-XSS Filter는 다음과 같은 요소로 구성된다</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lucy-XSS Filter Core  : Markup Parser를 통해 파싱한 HTML 문자열을 White List Object Model과 비교하여 필터링한 결과(Clean HTML)를 반환한다.</p>
</li>
<li>
<p>Markup Parser :  문자열을 파싱하여 HTML Object Model로 변환한다. DOM(MarkupParser.java)과 SAX(MarkupSaxParser.java) 두 가지 방식이 존재한다.</p>
</li>
<li>
<p>Configuration Builder : White List Configuration에 정의된 내용을 바탕으로 White List Object Model을 생성한다.</p>
</li>
<li>
<p>White List Configuration : 정상적인 HTML 구조를 화이트리스트 방식으로 정의한 설정 파일로서, XML 형식으로 되어 있다.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="image/internal.png" alt="내부 모듈 구조">
</div>
</div>
<div class="paragraph">
<p>Lucy-XSS Filter 객체를 생성하면 Configuration Builder는 White List Configuration에 정의된 내용을 바탕으로
White List Object Model을 생성하여 Lucy-XSS Filter Core로 전달한다.
Lucy-XSS Filter Core는 Markup Parser(DOM, SAX 둘 다 지원 )가 필터링 대상 HTML 문자열을 파싱하여 생성한 HTML Object Model을
White List Object Model과 비교하여 필터링한다.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-08-17 18:32:25 KST
</div>
</div>
</body>
</html>